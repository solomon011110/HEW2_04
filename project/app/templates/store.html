{% extends "layout.html" %}

{% block title %}
{{ product.name }}の詳細
{% endblock %}

{% block content %}
<div class="product">
    <div class="flex-box">
        <div class="slide-wrapper">
            <div id="slide" class="slide">
                {% for image in image_url %}
                <div>
                    <img src="{{ image }}" alt="{{ product.name }}">
                </div>
                {% endfor %}
            </div>
            <span id="prev" class="prev"></span>
            <span id="next" class="next"></span>
            <ul class="indicator" id="indicator">
                {% for image in image_url %}
                <li class="list"></li>
                {% endfor %}
            </ul>
        </div>
        <div class="text-box">
            <h3>{{ product.name }}</h3>
            <div class="review flex-box">
                <div class="star">
                    <p>{{review_avg_star}} {{"★"*int_review_avg_star}}{{"☆"*(5-int_review_avg_star)}}</p>
                </div>
                <p class="howmanyreviews">{{sum_review}}件</p>
            </div>
            <h4>\{{ product.sale_price }} <span class="tax">税込</span></h4>
            <form action="{{ url_for('main.add_to_cart', product_id=product.id) }}" method="POST">
                <button type="submit" class="btn">🛒 カートに追加</button>
            </form>
            <div class="explanation">
              <h5>商品説明</h5>
              <p>タマゴの入手方法
                  ポケモンのタマゴは、特定のポケモンを育て屋や預かり屋に預けることで入手できます。この施設は各地方に設けられており、条件に合うペアが一緒に預けられると一定の確率でタマゴが見つかることがあります。ペアとして適合する条件は、同じ「タマゴグループ」に属していることや、性別（通常はオスとメスの組み合わせ）です。タマゴが生まれると、プレイヤーが歩数を重ねることで孵化し、そこから新しいポケモンが誕生します。
                  
                  特徴
                  種類と遺伝
                  生まれたポケモンは通常、母親または種オス（片方がメタモンの場合も）に応じた種類になります。加えて、技や特性、性格が親から遺伝する仕組みもあります。これにより、戦闘で有利なポケモンを計画的に育成することが可能です。
                  
                  孵化の仕組み
                  タマゴを孵化させるには一定の歩数が必要です。この歩数は種族ごとに異なり、特定のアイテムや特性（「ほのおのからだ」や「マグマのよろい」など）を活用すれば効率が上がります。
                  
                  ユニークな遺伝技
                  親ポケモンが覚えている特定の技はタマゴから孵った子ポケモンに受け継ぐことがあり、これを「タマゴ技」と呼びます。これにより、通常では覚えられない技を持ったポケモンを作り出すことが可能です。
                  
                  不可タマゴグループ
                  一部のポケモン（伝説、幻、準伝説など）はタマゴを作れない「タマゴ未発見グループ」に属します。また、メタモンは例外的に他の多くのポケモンと組み合わせ可能で、繁殖の幅を広げる特別な存在です。
                  
                  プレイヤーにとっての意義
                  タマゴの仕組みは、プレイヤーがポケモンの個体値、性格、特性を調整し、理想の育成計画を立てるための重要な要素です。また、新たなポケモンを探求したりコレクションを充実させる楽しみを提供します。タマゴ孵化をテーマにしたチャレンジや国際孵化法（色違いポケモンを狙う方法）など、コミュニティでも人気のある要素となっています。
                  
                  ポケモンのタマゴは、そのシンプルな見た目以上に、戦略的な育成と冒険の楽しさを深める重要な要素と言えるでしょう。</p>
          </div>
      </div>
  </div>
  <div class="recommend flex-box">
    <a href="" class="item-box">
      <div class="image-box">
          <img src="./images/egg.jpg">
      </div>
      <div class="text-box">
          <p class="name">たまご</p>
          <p class="price">\10,000 <span class="tax">税込</span></p>
      </div>
      <div class="review flex-box">
          <div class="star">
              <p>☆☆☆☆☆</p>
          </div>
          <p class="howmanyreviews">100件</p>
      </div>
      <div class="cart flex-box">
          <p>詳しく見る</p>
      </div>
    </a>
    <a href="" class="item-box">
      <div class="image-box">
          <img src="./images/egg.jpg">
      </div>
      <div class="text-box">
          <p class="name">たまご</p>
          <p class="price">\10,000 <span class="tax">税込</span></p>
      </div>
      <div class="review flex-box">
          <div class="star">
              <p>☆☆☆☆☆</p>
          </div>
          <p class="howmanyreviews">100件</p>
      </div>
      <div class="cart flex-box">
          <p>詳しく見る</p>
      </div>
    </a>
    <a href="" class="item-box">
      <div class="image-box">
          <img src="./images/egg.jpg">
      </div>
      <div class="text-box">
          <p class="name">たまご</p>
          <p class="price">\10,000 <span class="tax">税込</span></p>
      </div>
      <div class="review flex-box">
          <div class="star">
              <p>☆☆☆☆☆</p>
          </div>
          <p class="howmanyreviews">100件</p>
      </div>
      <div class="cart flex-box">
          <p>詳しく見る</p>
      </div>
    </a>
    <a href="" class="item-box">
      <div class="image-box">
          <img src="./images/egg.jpg">
      </div>
      <div class="text-box">
          <p class="name">たまご</p>
          <p class="price">\10,000 <span class="tax">税込</span></p>
      </div>
      <div class="review flex-box">
          <div class="star">
              <p>☆☆☆☆☆</p>
          </div>
          <p class="howmanyreviews">100件</p>
      </div>
      <div class="cart flex-box">
          <p>詳しく見る</p>
      </div>
    </a>
  </div>

  <div>
    <div>
      <form action="{{ url_for('main.add_review', product_id=product.id) }}" method="post">
        <p class="bold">レビューを書く</p>
        <div class="stars" id="starRating" aria-label="星評価">
          <span class="star" data-value="1" role="button" aria-label="1星">★</span>
          <span class="star" data-value="2" role="button" aria-label="2星">★</span>
          <span class="star" data-value="3" role="button" aria-label="3星">★</span>
          <span class="star" data-value="4" role="button" aria-label="4星">★</span>
          <span class="star" data-value="5" role="button" aria-label="5星">★</span>
      </div>
        <label>タイトル<input type="text" name="title"></label>
        <label>本文<input type="text" name="describe"></label>
        <div id="error" class="error" style="display: none;">すべて入力してください。</div>
        <input type="submit" value="送信">
      </form>
    </div>
    
    <div>
      <h4>この商品のレビュー</h4>
      <h5>{{review_avg_star}} {{"★"*int_review_avg_star}}{{"☆"*(5-int_review_avg_star)}}({{sum_review}}件中)</h5>
      {% for review in reviews %}
      <p>{{review.title}} - 
        {{"★"*review.star}}{{"☆"*(5-review.star)}}</p>
      <p>{{review.describe}}</p>
      <br/>
      {% endfor %}
    </div>
  </div>
</div>

  <div style="margin-bottom: 200px;"><!-- 実装するときけしてください　footerできるまで下スぺ-ス作りたいだけ --></div>
        </div>
    </div>
</div>
<script>
  const slideContainer = document.querySelector('.slide');
  const prev = document.getElementById('prev');
  const next = document.getElementById('next');
  const indicator = document.getElementById('indicator');
  const slides = document.querySelectorAll('.slide > div');
  const totalSlides = slides.length;
  const slideWidth = 100 / totalSlides;
  slideContainer.style.width = `${totalSlides * 100}%`;
  slides.forEach((slide) => {
    slide.style.width = `${slideWidth}%`;
  });
  let count = 0;
  let autoPlayInterval;
  function updateSlidePosition() {
    slideContainer.style.transform = `translateX(-${count * slideWidth}%)`;
  }
  function updateIndicatorColors() {
    const lists = document.querySelectorAll('.list');
    lists.forEach((list, i) => {
      list.style.backgroundColor = i === count % totalSlides ? '#000' : '#fff';
    });
  }
  function nextClick() {
    count++;
    if (count >= totalSlides) {
      count = 0;
    }
    updateSlidePosition();
    updateIndicatorColors();
  }
  function prevClick() {
    count--;
    if (count < 0) {
      count = totalSlides - 1;
    }
    updateSlidePosition();
    updateIndicatorColors();
  }
  next.addEventListener('click', () => {
    nextClick();
    resetAutoPlayInterval();
  });
  prev.addEventListener('click', () => {
    prevClick();
    resetAutoPlayInterval();
  });
  indicator.addEventListener('click', (event) => {
    if (event.target.classList.contains('list')) {
      const index = Array.from(indicator.children).indexOf(event.target);
      setActiveSlide(index);
    }
  });
  function setActiveSlide(index) {
    count = index;
    updateSlidePosition();
    updateIndicatorColors();
    resetAutoPlayInterval()
  }
  updateIndicatorColors();

  document.addEventListener("DOMContentLoaded", () => {
    const reviewForm = document.getElementById("reviewForm");
    const reviewInput = document.getElementById("review");
    const reviewsContainer = document.getElementById("reviews");
    const starRating = document.getElementById("starRating");
    const errorMessage = document.getElementById("error");
    let selectedRating = 0;

    // 星評価の選択機能
    starRating.addEventListener("click", (e) => {
        if (e.target.classList.contains("star")) {
            const stars = starRating.querySelectorAll(".star");
            selectedRating = parseInt(e.target.getAttribute("data-value"), 10);

            stars.forEach(star => {
                star.classList.remove("selected");
                if (parseInt(star.getAttribute("data-value"), 10) <= selectedRating) {
                    star.classList.add("selected");
                }
            });
        }
    });

    reviewForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const reviewText = reviewInput.value.trim();

        if (reviewText && selectedRating > 0) {
            const reviewElement = document.createElement("div");
            reviewElement.classList.add("review");
            reviewElement.innerHTML = `<strong>評価: ${selectedRating} / 5</strong><br>${reviewText}`;

            reviewsContainer.appendChild(reviewElement);
            reviewInput.value = "";

            // Placeholder textの削除
            const placeholder = reviewsContainer.querySelector("p");
            if (placeholder) {
                placeholder.remove();
            }

            // 星評価のリセット
            const stars = starRating.querySelectorAll(".star");
            stars.forEach(star => star.classList.remove("selected"));
            selectedRating = 0;

            // エラーメッセージの非表示
            errorMessage.style.display = "none";
        } else {
            errorMessage.style.display = "block";
        }
    });
});

</script>
{% endblock %}
